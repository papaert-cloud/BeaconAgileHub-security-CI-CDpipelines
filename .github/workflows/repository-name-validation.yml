name: "ðŸŽ¯ Repository Name Validation"

on:
  workflow_dispatch:
    inputs:
      validation_scope:
        description: 'Validation scope'
        required: false
        default: 'comprehensive'
        type: choice
        options: ['basic', 'comprehensive', 'integration']
      run_oidc_test:
        description: 'Test OIDC authentication'
        required: false
        default: true
        type: boolean

permissions:
  id-token: write
  contents: read

concurrency:
  group: repo-name-validation-${{ github.ref }}
  cancel-in-progress: true

env:
  # Updated repository references
  REPOSITORY_NAME: papaert-cloud/peter-security-CI-CDpipelines
  AWS_REGION: us-east-1
  AWS_ROLE_ARN: arn:aws:iam::005965605891:role/GitHubActionsRole
  EDA_ENDPOINT: http://148.230.94.85:5000/security-alert

jobs:
  # Job 1: Basic Repository Validation
  basic-validation:
    name: "ðŸ” Basic Repository Validation"
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    outputs:
      repository_name: ${{ steps.validate.outputs.repository_name }}
      validation_status: ${{ steps.validate.outputs.status }}
      
    steps:
      - name: "ðŸ“‹ Checkout Repository"
        uses: actions/checkout@v4
        
      - name: "ðŸ” Validate Repository Context"
        id: validate
        run: |
          echo "=== REPOSITORY VALIDATION ==="
          echo "Expected: ${{ env.REPOSITORY_NAME }}"
          echo "Actual: ${{ github.repository }}"
          
          if [ "${{ github.repository }}" = "${{ env.REPOSITORY_NAME }}" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "repository_name=${{ github.repository }}" >> $GITHUB_OUTPUT
            echo "âœ… Repository name validation: PASSED"
          else
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "repository_name=${{ github.repository }}" >> $GITHUB_OUTPUT
            echo "âŒ Repository name validation: FAILED"
            echo "  Expected: ${{ env.REPOSITORY_NAME }}"
            echo "  Actual: ${{ github.repository }}"
          fi
          
      - name: "ðŸ“ Check for Old Repository References"
        run: |
          echo "=== SCANNING FOR OLD REFERENCES ==="
          
          OLD_REFS=0
          
          # Check for BeaconAgileHub references
          if grep -r "BeaconAgileHub-security-CI-CDpipelines" . --exclude-dir=.git --exclude="*.log" 2>/dev/null; then
            echo "âŒ Found BeaconAgileHub references"
            OLD_REFS=$((OLD_REFS + 1))
          else
            echo "âœ… No BeaconAgileHub references found"
          fi
          
          # Check for old badge references
          if grep -r "papaert/sbom" . --exclude-dir=.git --exclude="*.log" 2>/dev/null; then
            echo "âŒ Found old badge references (papaert/sbom)"
            OLD_REFS=$((OLD_REFS + 1))
          else
            echo "âœ… No old badge references found"
          fi
          
          echo "Old references found: $OLD_REFS"
          
          if [ $OLD_REFS -gt 0 ]; then
            echo "âš ï¸  WARNING: Found $OLD_REFS old repository references"
            echo "ðŸ’¡ Run: ./scripts/repository-name-update.sh"
          else
            echo "âœ… Repository name update appears complete"
          fi

  # Job 2: OIDC Authentication Test
  oidc-validation:
    name: "ðŸ” OIDC Authentication Validation"
    needs: basic-validation
    if: ${{ needs.basic-validation.outputs.validation_status == 'success' && inputs.run_oidc_test }}
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    
    steps:
      - name: "ðŸ” Configure AWS Credentials via OIDC"
        id: aws-auth
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          role-session-name: repo-name-validation-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}
          mask-aws-account-id: false
          
      - name: "ðŸŽ¯ Verify OIDC Authentication"
        run: |
          echo "=== OIDC AUTHENTICATION VALIDATION ==="
          
          # Get caller identity
          CALLER_IDENTITY=$(aws sts get-caller-identity)
          ARN=$(echo $CALLER_IDENTITY | jq -r '.Arn')
          
          echo "Session ARN: $ARN"
          
          # Validate assumed role
          if [[ $ARN == *"assumed-role/GitHubActionsRole"* ]]; then
            echo "âœ… OIDC authentication: SUCCESSFUL"
            echo "  âœ… Using temporary credentials"
            echo "  âœ… Correct role assumption"
          else
            echo "âŒ OIDC authentication: FAILED"
            echo "  âŒ Not using expected assumed role"
            exit 1
          fi
          
          # Test AWS service access
          echo ""
          echo "=== AWS SERVICE ACCESS TEST ==="
          
          # Test S3 access
          echo "Testing S3 access..."
          aws s3 ls || echo "S3 access test completed"
          
          # Test EC2 access
          echo "Testing EC2 access..."
          aws ec2 describe-regions --max-items 2
          
          echo "âœ… AWS service access tests completed"

  # Job 3: Integration Testing
  integration-validation:
    name: "ðŸ”— Integration Validation"
    needs: [basic-validation, oidc-validation]
    if: ${{ always() && needs.basic-validation.outputs.validation_status == 'success' && inputs.validation_scope != 'basic' }}
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    
    steps:
      - name: "ðŸ“‹ Checkout Repository"
        uses: actions/checkout@v4
        
      - name: "ðŸ” Configure AWS Credentials"
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          role-session-name: integration-test-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}
          
      - name: "ðŸ¦£ Test EDA Webhook Integration"
        run: |
          echo "=== EDA INTEGRATION TEST ==="
          
          # Test EDA webhook endpoint
          echo "Testing EDA webhook at: ${{ env.EDA_ENDPOINT }}"
          
          # Send test event
          curl -X POST "${{ env.EDA_ENDPOINT }}" \
            -H 'Content-Type: application/json' \
            -H 'User-Agent: Repository-Name-Validation/1.0' \
            -d '{
              "severity": "info",
              "summary": "Repository name validation test",
              "source": "github-actions-validation",
              "environment": "test",
              "repository": "${{ github.repository }}",
              "workflow_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
            }' && echo " âœ…" || echo " âš ï¸ "
            
          echo "EDA webhook test completed"
          
      - name: "ðŸ“‹ Test Documentation Links"
        run: |
          echo "=== DOCUMENTATION VALIDATION ==="
          
          # Check README.md for correct repository references
          if [ -f "README.md" ]; then
            echo "Checking README.md..."
            
            # Look for GitHub URLs
            if grep -q "github.com/${{ github.repository }}" README.md; then
              echo "âœ… README contains correct repository URLs"
            else
              echo "âš ï¸  README may not contain updated repository URLs"
            fi
            
            # Check for badges
            BADGE_COUNT=$(grep -c "shields.io\|badge" README.md || echo "0")
            echo "â„¹ï¸  Found $BADGE_COUNT badges in README"
          else
            echo "âš ï¸  README.md not found"
          fi

  # Job 4: Comprehensive Validation Summary
  validation-summary:
    name: "ðŸ“‹ Validation Summary"
    needs: [basic-validation, oidc-validation, integration-validation]
    if: always()
    runs-on: ubuntu-22.04
    timeout-minutes: 5
    
    steps:
      - name: "ðŸ“‹ Generate Validation Report"
        run: |
          echo "# ðŸŽ¯ Repository Name Validation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Execution Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: ${{ needs.basic-validation.outputs.repository_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Validation Scope**: ${{ inputs.validation_scope }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Execution Time**: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          
          # Basic validation result
          BASIC_STATUS="${{ needs.basic-validation.outputs.validation_status == 'success' && 'âœ… PASSED' || 'âŒ FAILED' }}"
          echo "| Repository Name | $BASIC_STATUS | ${{ needs.basic-validation.outputs.repository_name }} |" >> $GITHUB_STEP_SUMMARY
          
          # OIDC validation result
          if [ "${{ inputs.run_oidc_test }}" = "true" ]; then
            OIDC_STATUS="${{ needs.oidc-validation.result == 'success' && 'âœ… PASSED' || needs.oidc-validation.result == 'skipped' && 'â­ï¸ SKIPPED' || 'âŒ FAILED' }}"
            echo "| OIDC Authentication | $OIDC_STATUS | AWS assumed role validation |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| OIDC Authentication | â­ï¸ SKIPPED | User disabled OIDC testing |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Integration validation result
          INTEGRATION_STATUS="${{ needs.integration-validation.result == 'success' && 'âœ… PASSED' || needs.integration-validation.result == 'skipped' && 'â­ï¸ SKIPPED' || 'âŒ FAILED' }}"
          echo "| Integration Tests | $INTEGRATION_STATUS | EDA webhook and documentation |" >> $GITHUB_STEP_SUMMARY
          
          # Calculate overall status
          BASIC_OK=$([ "${{ needs.basic-validation.outputs.validation_status }}" = "success" ] && echo 1 || echo 0)
          OIDC_OK=$([ "${{ needs.oidc-validation.result }}" = "success" ] || [ "${{ inputs.run_oidc_test }}" = "false" ] && echo 1 || echo 0)
          INTEGRATION_OK=$([ "${{ needs.integration-validation.result }}" = "success" ] || [ "${{ needs.integration-validation.result }}" = "skipped" ] && echo 1 || echo 0)
          
          TOTAL_OK=$((BASIC_OK + OIDC_OK + INTEGRATION_OK))
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Overall Status" >> $GITHUB_STEP_SUMMARY
          
          if [ $TOTAL_OK -eq 3 ]; then
            echo "- **Status**: ðŸŽ‰ **REPOSITORY NAME UPDATE SUCCESSFUL**" >> $GITHUB_STEP_SUMMARY
            echo "- **All Validations**: PASSED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸŽ¯ Ready for Production" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Repository name correctly updated" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… OIDC authentication working" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Integrations validated" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status**: ðŸ”§ **REQUIRES ATTENTION**" >> $GITHUB_STEP_SUMMARY
            echo "- **Passed**: $TOTAL_OK/3 validations" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ› ï¸ Action Required" >> $GITHUB_STEP_SUMMARY
            echo "Please review failed validations and apply necessary fixes." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo ""
          echo "âœ… Repository name validation completed!"
          echo "Check the job summary for detailed results."